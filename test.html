import groovy.json.JsonSlurper
import jenkins.model.* 

def artifacts_list = []
def artifactory_scheme = "https"
def artifactory_host = "artifactory.intranet"
def artifactory_port = ""

def artifactory_url = "${artifactory_scheme}://artifactory.intranet/artifactory"
def artifactory_api = "/api/search/artifact"
def artifactory_repo = "buffer"
def artifactory_search = "*.ear"

def artifactory_user = ""
def artifactory_password = ""
def error_list = []
def release = ""

def jenkinsCredentials = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
        com.cloudbees.plugins.credentials.Credentials.class,
        Jenkins.instance,
        null,
        null
);

for (creds in jenkinsCredentials) {
  if(creds.id == "AD Jenkins"){
    artifactory_user = creds.username
    artifactory_password = creds.password
    }
}

try {
    def http_client = new URL("${artifactory_url}${artifactory_api}?name=${artifactory_search}&repos=${artifactory_repo}").openConnection() as HttpURLConnection
    http_client.setRequestMethod('GET')
    http_client.setRequestProperty('User-Agent', 'jenkins-groovy')
    http_client.setRequestProperty('Accept', 'application/json')
    http_client.setRequestProperty('Authorization', "Basic " +
        "${artifactory_user}:${artifactory_password}".bytes.encodeBase64().toString())
    http_client.connect()
    def artifactory_response = [:]
    if (http_client.responseCode == 200) {
        artifactory_response = new JsonSlurper().parseText(http_client.inputStream.getText('UTF-8'))
    } else {
        error_list.add("HTTP response error:" + " ${http_client.responseCode}") 
        // System.exit(0)
    }
    artifactory_response.results.each { artifact ->
		if (artifact.uri.contains("SW-FCC12/builds")) {
			release = artifact.uri - "https://artifactory.intranet/artifactory/api/storage/buffer/SW-FCC12/builds/"
			artifacts_list.add(release )
		}
    }
}
catch (Exception e) {
    // handle exceptions like timeout, connection errors, etc.
    error_list.add("Error:" + e)
}

return artifacts_list + error_list
