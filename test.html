#!/bin/bash
set -e
sqlplus -l $1/$2@$3 <<EOF
WHENEVER OSERROR EXIT 9;
WHENEVER SQLERROR EXIT SQL.SQLCODE;
select * from dual;
EOF

#!/bin/bash

if [ -z "${CHANGE_BRANCH}" ]; then
  arguments=$(paste -s -d ' ' ./Installers/$BRANCH_NAME/install.txt)
else
  arguments=$(paste -s -d ' ' ./Installers/$CHANGE_BRANCH/install.txt)
fi;


export NLS_LANG=AMERICAN_AMERICA.AL32UTF8
text="select dependency from table(fccucb.check_restart_adapters.fn_find_need_reload_obj('$arguments'));"

echo exit | sqlplus $1[$DEFAULT_ORA_SCHEMA]/$2@$3 <<< $text > result.txt

cat result.txt

if grep -q 'ERROR at line' result.txt; then
  echo 'Произошла ошибка в функции , при проверке объектов из install.txt'
  exit 1
fi

if  grep -q 'Перезагрузка не требуется' result.txt && [[ $arguments =~ RESTART_ADAPTER= ]]; then
  echo 'В файле install.txt указана необходимость перезагрузки адаптеров, однако зависимости с адаптерными пакетами не найдены, просьба проверить'
  exit 1
elif ! grep -q 'Перезагрузка не требуется' result.txt && [[ ! $arguments =~ RESTART_ADAPTER= ]]; then
  echo 'В файле install.txt не указана необходимость перезагрузки адаптеров, однако найдена связь с адаптерными пакетами, просьба проверить'
  exit 1
else
  echo 'successfully passed stage "Checking for reload adapters"'
  exit 0
fi
