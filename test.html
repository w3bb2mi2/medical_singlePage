pipeline {
	agent any

	options {
		disableConcurrentBuilds()
		timestamps()
	}

	environment {
		BRANCH_NAME = "${env.BRANCH_NAME}"
		WORK_FOLDER = "${env.WORKSPACE}"
		GIT_ADDRESS = 'http://git.intranet/scm/ABS/fcc-fccba.git'
		PATCH_NAME = "${env.BRANCH_NAME}"
		// SLEEP_TIME = 0
		DB_CREDENTIALS = credentials('oracle_proxy_user_flex12')
        DB_SERVER = 'fox06.IMB.RU:21567/FCC03.IMB.RU'
	}

	stages {
        
		stage('Clear workspace') {
			steps {
			    script {
                       currentBuild.displayName = "#${BUILD_NUMBER} - ${BRANCH_NAME} - ${env.ENVIRONMENT}"
                       }
				deleteDir()
			}
		}
		
		stage('Checkout branch') {
			  steps {
				echo 'Checking out branch'
				checkout([
					$class: 'GitSCM',
					branches:[[name: "*/${BRANCH_NAME}"]],
					extensions: [[$class: 'GitLFSPull'],[$class: 'RelativeTargetDirectory', relativeTargetDir: './']],
					userRemoteConfigs: [[credentialsId: 'AD Jenkins', url: env.GIT_ADDRESS]]
				])
				library identifier: "fcc@$BRANCH_NAME", retriever: legacySCM(scm)
				echo 'Checked out branch'
			  }
		}
		

		stage('Checkout master') {
		  steps {
			echo 'Checking out master'

			checkout([
				$class: 'GitSCM',
				branches:[[name: '*/master']],
				extensions: [[$class: 'GitLFSPull'],[$class: 'RelativeTargetDirectory', relativeTargetDir: 'MASTER']],
				userRemoteConfigs: [[credentialsId: 'AD Jenkins', url: env.GIT_ADDRESS]]
			])

			echo 'Checked out master'
		  }
		}
		
        stage('Build patch') {
            steps {
                buildPatch "${PATCH_NAME}"
            }
        }
		
        stage('Create archive') {
            steps {
		        sh """
					cd ${WORK_FOLDER}/${PATCH_NAME}; tar -cvzf ${WORK_FOLDER}/${PATCH_NAME}.tar.gz ./*
					cd ..
                """
				
				archiveArtifacts artifacts: "**/*.gz", allowEmptyArchive: true
            }
        }
	}
}
